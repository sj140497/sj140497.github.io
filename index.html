<!DOCTYPE html>
<html>
<title>Q5040916</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway">
<style>
body,h1 {font-family: "Raleway", sans-serif}
body, html {height: 100%}
.bgimg {
    background-image: url('https://raw.githubusercontent.com/sj140497/FinalYearDAW/master/Misc/hUPIsqu.jpg');
    min-height: 100%;
    background-position: center;
    background-size: cover;
}
</style>
<body> 
<div class="bgimg w3-display-container w3-animate-opacity w3-text-white">
  <div class="w3-display-topleft w3-padding-large w3-xlarge">
  </div>
  <div class="w3-display-middle">
      <div class="wrapper">
    <h1 class="w3-jumbo w3-animate-top">Sean Johnson: Final Year Project</h1>
    <hr class="w3-border-grey" style="margin:auto;width:40%">
    <p class="w3-large w3-center">Digital Audio Workstation</p>
    <p class="w3-center">Track 1
    <canvas class="visualTrack1" width="640" height="100"></canvas>
    Volume <input type="range" name="volumeControl" min="0" max="1" step="any" onchange="t1ChangeVolume(this.value);"> <br />
    Bass Boost <input type="range" name="biquadControl" min="40" max="440" value = "0" step="any" onchange="t1ChangeBiquad(this.value);"> <br />
    </p>
    <p class="w3-center">Track 2
    <canvas class="visualTrack2" width="640" height="100"></canvas>
    Volume <input type="range" name="volumeControl2" min="0" max="1" step="any" onchange="t2ChangeVolume(this.value);"> <br />
    Bass Boost <input type="range" name="biquadControl2" min="40" max="440" value = "0" step="any" onchange="t2ChangeBiquad(this.value);"> <br />
    </p>
    <canvas class="visualTrack2" width="640" height="100"></canvas> 
    <button id="songControl" onclick="songControls()"> Pause </button>
      </div>
  </div>
</div>
    <script>
                  
        var ctx = new (window.AudioContext || window.webkitAudioContext)();
        var voiceSelect = document.getElementById("voice");
        var source;
        var stream;
        
        //Code from Kevin Ennis - Day 2 + 3 of blog:
        function makeDistortionCurve(amount) {
        var k = typeof amount === 'number' ? amount : 50,
          n_samples = 44100,
          curve = new Float32Array(n_samples),
          deg = Math.PI / 180,
          i = 0,
          x;
        for ( ; i < n_samples; ++i ) {
          x = i * 2 / n_samples - 1;
          curve[i] = ( 3 + k ) * x * 20 * deg / ( Math.PI + k * Math.abs(x) );
        }
        return curve;
      };
      
      
      //Setting up nodes for track 1----------------------------
        var t1GainNode = ctx.createGain();
        t1GainNode.gain.value = 0.5;
        
        var t1Analyser = ctx.createAnalyser();
        t1Analyser.minDecibels = -90;
        t1Analyser.maxDecibels = -10;
        t1Analyser.smoothingTimeConstant = 0.85;
        
        var t1Distortion = ctx.createWaveShaper();
        
        var t1LowshelfFilter = ctx.createBiquadFilter();
        t1LowshelfFilter.type = "lowshelf";
        t1LowshelfFilter.frequency.value = 40;
        t1LowshelfFilter.gain.value = 25;
        //Finish setting up nodes for track 1------------------

        //Connecting nodes together for track 1
        t1GainNode.connect(t1LowshelfFilter);
        t1LowshelfFilter.connect(t1Distortion);
        t1Distortion.connect(t1Analyser);
        t1Analyser.connect(ctx.destination);
        //Finish connecting nodes together for track 1
        
        //Setting up nodes for track 2-----------------------
        var t2GainNode = ctx.createGain();
        t2GainNode.gain.value = 0.5;
        
        var t2Analyser = ctx.createAnalyser();
        t2Analyser.minDecibels = -90;
        t2Analyser.maxDecibels = -10;
        t2Analyser.smoothingTimeConstant = 0.85;
        
        var t2Distortion = ctx.createWaveShaper();
        
        var t2LowshelfFilter = ctx.createBiquadFilter();
        t2LowshelfFilter.type = "lowshelf";
        t2LowshelfFilter.frequency.value = 40;
        t2LowshelfFilter.gain.value = 25;
        //Finish setting up nodes for track 2--------------

        //Connecting nodes together for track 2
        t2GainNode.connect(t2LowshelfFilter);
        t2LowshelfFilter.connect(t2Distortion);
        t2Distortion.connect(t2Analyser);
        t2Analyser.connect(ctx.destination);
        //Finish connecting nodes together for track 2
        
        var intendedWidth = document.querySelector('.wrapper').clientWidth;
        
        var t1Canvas = document.querySelector('.visualTrack1');
        var t1CanvasCtx = t1Canvas.getContext("2d");
        t1Canvas.setAttribute('width',intendedWidth);
        var t1DrawVisual;
        
        var t2Canvas = document.querySelector('.visualTrack2');
        var t2CanvasCtx = t2Canvas.getContext("2d");
        t2Canvas.setAttribute('width',intendedWidth);
        var t2DrawVisual;
      
        //Hardcoding a single song in for now until I figure out multiple songs
        var t1Source, t1Buffer, t2Source, t2Buffer;
        t1Request = new XMLHttpRequest();
        t1Request.open('GET', 'https://raw.githubusercontent.com/sj140497/FinalYearDAW/master/Misc/rhcpVocal.mp3', true);
        t1Request.responseType = 'arraybuffer';
        
        t2Request = new XMLHttpRequest();
        t2Request.open('GET', 'https://raw.githubusercontent.com/sj140497/FinalYearDAW/master/Misc/rhcpGuitar.mp3', true);
        t2Request.responseType = 'arraybuffer';
        
        t1Request.onload = function() {
          var audioData = t1Request.response;

          ctx.decodeAudioData(audioData, function(buffer) {
              t1Buffer = buffer;
              t1Source = ctx.createBufferSource();
              t1Source.buffer = t1Buffer;
              t1Source.connect(t1GainNode);
              t1Source.loop = true;
              t1Source.start();
              visualize(t1Canvas, t1CanvasCtx, t1Analyser, t1DrawVisual);
            }, function(e){ console.log("Error with decoding audio data" + e.err);});
        };
        
        t2Request.onload = function() {
          var audioData = t2Request.response;

          ctx.decodeAudioData(audioData, function(buffer) {
              t2Buffer = buffer;
              t2Source = ctx.createBufferSource();
              t2Source.buffer = t2Buffer;
              t2Source.connect(t2GainNode);
              t2Source.loop = true;
              t2Source.start();
              visualize(t2Canvas, t2CanvasCtx, t2Analyser, t2DrawVisual);
            }, function(e){ console.log("Error with decoding audio data" + e.err);});
        };

        t1Request.send();  
        t2Request.send();
        //End of playing single song
        
        function visualize(canvas, canvasCtx, analyser, drawVisual) {
        WIDTH = canvas.width;
        HEIGHT = canvas.height;
      

        analyser.fftSize = 2048;
        var bufferLength = analyser.fftSize;
        console.log(bufferLength);
        console.log("visualize");
        var dataArray = new Uint8Array(bufferLength);

        canvasCtx.clearRect(0, 0, WIDTH, HEIGHT);

        var draw = function() {
            console.log("draw call");

          drawVisual = requestAnimationFrame(draw);

          analyser.getByteTimeDomainData(dataArray);

          canvasCtx.fillStyle = 'rgb(200, 200, 200)';
          canvasCtx.fillRect(0, 0, WIDTH, HEIGHT);

          canvasCtx.lineWidth = 2;
          canvasCtx.strokeStyle = 'rgb(0, 0, 0)';

          canvasCtx.beginPath();

          var sliceWidth = WIDTH * 1.0 / bufferLength;
          var x = 0;

          for(var i = 0; i < bufferLength; i++) {

            var v = dataArray[i] / 128.0;
            var y = v * HEIGHT/2;

            if(i === 0) {
              canvasCtx.moveTo(x, y);
            } else {
              canvasCtx.lineTo(x, y);
            }

            x += sliceWidth;
          }

          canvasCtx.lineTo(canvas.width, canvas.height/2);
          canvasCtx.stroke();
        };
        draw();
    }

        //Function to pause and resume current song onclick of button        
        function songControls() {
            if(ctx.state === 'running') {
                ctx.suspend().then(function() {
                    document.getElementById("songControl").textContent = "Resume";
                });
            } else if(ctx.state === 'suspended') {
                ctx.resume().then(function() {
                    document.getElementById("songControl").textContent = "Pause";
                });
            }
        }
        //Pause and resume function end
              
        //functions to update values of volume/effects based on change in slider
        function t1ChangeVolume(val) {           
            t1GainNode.gain.value = val;
        }
        
        function t1ChangeBiquad(val) {
            t1LowshelfFilter.frequency.value = val;
        }
        
        function t2ChangeVolume(val) {           
            t2GainNode.gain.value = val;
        }
        
        function t2ChangeBiquad(val) {
            t2LowshelfFilter.frequency.value = val;
        }
               
    </script>
</body>
</html>
