<!DOCTYPE html>
<html>
<title>Q5040916</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway">
<style>
body,h1 {font-family: "Raleway", sans-serif}
body, html {height: 100%}
.bgimg {
    background-image: url('https://raw.githubusercontent.com/sj140497/FinalYearDAW/master/Misc/hUPIsqu.jpg');
    min-height: 100%;
    background-position: center;
    background-size: cover;
}
</style>
<body> 
<div class="bgimg w3-display-container w3-animate-opacity w3-text-white">
  <div class="w3-display-topleft w3-padding-large w3-xlarge">
  </div>
  <div class="w3-display-middle">
      <div class="wrapper">
    <h1 class="w3-jumbo w3-animate-top">Sean Johnson: Final Year Project</h1>
    <hr class="w3-border-grey" style="margin:auto;width:40%">
    <p class="w3-large w3-center">Digital Audio Workstation</p>
    <canvas class="visualizer" width="640" height="100"></canvas> 
    <button id="songControl" onclick="songControls()"> Pause </button>
    <form>
        <p>Volume</p><input type="range" name="volumeControl" min="0" max="1" step="any" onchange="changeVolume(this.value);">
        <p>Lowshelf</p><input type="range" name="biquadControl" min="40" max="440" value = "0" step="any" onchange="changeBiquad(this.value);">
        <p>Distortion <input type="checkbox" name="distortion" id="distortionCheckbox"> </p>
        <p>Delay</p><input type="range" name="delayControl" min="0" max="1" value = "0" step="any" onchange="changeDelay(this.value);">
    </form>
      </div>
  </div>
</div>
    <script>
                  
        var ctx = new (window.AudioContext || window.webkitAudioContext)();
        var voiceSelect = document.getElementById("voice");
        var source;
        var stream;
        
        //Code from Kevin Ennis - Day 2 + 3 of blog:
        function makeDistortionCurve(amount) {
        var k = typeof amount === 'number' ? amount : 50,
          n_samples = 44100,
          curve = new Float32Array(n_samples),
          deg = Math.PI / 180,
          i = 0,
          x;
        for ( ; i < n_samples; ++i ) {
          x = i * 2 / n_samples - 1;
          curve[i] = ( 3 + k ) * x * 20 * deg / ( Math.PI + k * Math.abs(x) );
        }
        return curve;
      };
      
        var gainNode = ctx.createGain();
        gainNode.gain.value = 0.5;
        
      
        //Delay Test, need to create new instances of gain, biquadfilter and delay
        var delayGain = ctx.createGain();
        delayGain.gain.value = 0;
       
        var delayFeedback = ctx.createGain();
        delayFeedback.gain.value = 0.8; //0.8
        
        var delay = ctx.createDelay();
        delay.delayTime.value = 0.5; //0.5
            
        var delayFilter = ctx.createBiquadFilter();
        delayFilter.frequency.value = 1000;
        
        var analyser = ctx.createAnalyser();
        analyser.minDecibels = -90;
        analyser.maxDecibels = -10;
        analyser.smoothingTimeConstant = 0.85;
              
        delayFeedback.connect(delayFilter);
        delay.connect(delayFeedback);
        delayFilter.connect(delay);
        delay.connect(delayGain);
        delayGain.connect(gainNode);
        gainNode.connect(analyser);
        analyser.connect(ctx.destination);
        //End of creating delay variables
       
        
        var distortion = ctx.createWaveShaper();
        distortion.connect(gainNode);
        
        var lowshelfFilter = ctx.createBiquadFilter();
        lowshelfFilter.type = "lowshelf";
        lowshelfFilter.frequency.value = 40;
        lowshelfFilter.gain.value = 25;
        lowshelfFilter.connect(distortion);
      
        //Hardcoding a single song in for now until I figure out multiple songs
        var soundSource, songBuffer;
        request = new XMLHttpRequest();
        request.open('GET', 'https://raw.githubusercontent.com/sj140497/FinalYearDAW/master/Misc/4062.mp3', true);
        request.responseType = 'arraybuffer';

        request.onload = function() {
          var audioData = request.response;

          ctx.decodeAudioData(audioData, function(buffer) {
              songBuffer = buffer;
              soundSource = ctx.createBufferSource();
              soundSource.buffer = songBuffer;
              soundSource.connect(lowshelfFilter);
              soundSource.connect(delay);
              soundSource.loop = true;
              soundSource.start();
              visualize();
            }, function(e){ console.log("Error with decoding audio data" + e.err);});
        };

        request.send();  
        //End of playing single song
        
        var canvas = document.querySelector('.visualizer');
        var canvasCtx = canvas.getContext("2d");

        var intendedWidth = document.querySelector('.wrapper').clientWidth;

        canvas.setAttribute('width',intendedWidth);

        var drawVisual;
        
        function visualize() {
        WIDTH = canvas.width;
        HEIGHT = canvas.height;
      

        analyser.fftSize = 2048;
        var bufferLength = analyser.fftSize;
        console.log(bufferLength);
        console.log("visualize");
        var dataArray = new Uint8Array(bufferLength);

        canvasCtx.clearRect(0, 0, WIDTH, HEIGHT);

        var draw = function() {
            console.log("draw call");

          drawVisual = requestAnimationFrame(draw);

          analyser.getByteTimeDomainData(dataArray);

          canvasCtx.fillStyle = 'rgb(200, 200, 200)';
          canvasCtx.fillRect(0, 0, WIDTH, HEIGHT);

          canvasCtx.lineWidth = 2;
          canvasCtx.strokeStyle = 'rgb(0, 0, 0)';

          canvasCtx.beginPath();

          var sliceWidth = WIDTH * 1.0 / bufferLength;
          var x = 0;

          for(var i = 0; i < bufferLength; i++) {

            var v = dataArray[i] / 128.0;
            var y = v * HEIGHT/2;

            if(i === 0) {
              canvasCtx.moveTo(x, y);
            } else {
              canvasCtx.lineTo(x, y);
            }

            x += sliceWidth;
          }

          canvasCtx.lineTo(canvas.width, canvas.height/2);
          canvasCtx.stroke();
        };
        draw();
    }


        //Function to pause and resume current song onclick of button        
        function songControls() {
            if(ctx.state === 'running') {
                ctx.suspend().then(function() {
                    document.getElementById("songControl").textContent = "Resume";
                });
            } else if(ctx.state === 'suspended') {
                ctx.resume().then(function() {
                    document.getElementById("songControl").textContent = "Pause";
                });
            }
        }
        //Pause and resume function end
        
        //functions to update values of volume/effects based on change in slider
        function changeVolume(val) {
            gainNode.gain.value = val;
        }
        
        function changeBiquad(val) {
            lowshelfFilter.frequency.value = val;
        }
        
        function changeDelay(val) {
            delayGain.gain.value = val;
        }
       
        distortion.oversample = '4x';
        distortionCheckbox = document.querySelector("#distortionCheckbox");
        distortionCheckbox.onchange = function() {
            if(distortionCheckbox.checked) {
                distortion.curve = makeDistortionCurve(50);
            }
            else {
                distortion.curve = makeDistortionCurve(0);
            }
        }
    </script>
</body>
</html>
