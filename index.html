<!DOCTYPE html>
<html>
<title>Q5040916</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway"> 
<style>
body,h1 {font-family: "Raleway", sans-serif} 
body, html {height: 100%}
.bgimg {
    background-image: url('https://raw.githubusercontent.com/sj140497/FinalYearDAW/master/Misc/dark-grey-background-pattern-i7.jpg');
    min-height: 100%;
    background-position: center;
    background-size: cover;
}


/* The slider itself */
.slider {
    -webkit-appearance: none;
    width: 30%;
    height: 12px;
    border-radius: 5px;   
    background: #d3d3d3;
    outline: none;
    opacity: 0.7;
    -webkit-transition: .2s;
    transition: opacity .2s;
}

.slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 30px;
    height: 12px;
    border-radius: 50%; 
    background: #db364a;
    cursor: pointer;
}

.slider::-moz-range-thumb {
    width: 30px;
    height: 12px;
    border-radius: 50%;
    background: #db364a;
    cursor: pointer;
}


</style>
<body> 
<div class="bgimg w3-display-container w3-animate-opacity w3-text-white">
  <div class="w3-display-topleft w3-padding-large w3-xlarge">
  </div>
  <div class="w3-display-middle">
      <div class="wrapper">
    <h1 class="w3-jumbo w3-animate-top">Sean Johnson: Final Year Project</h1>
    <hr class="w3-border-grey" style="margin:auto;width:40%">
    <p class="w3-large w3-center">Digital Audio Workstation</p>
    <p class="w3-center slidecontainer"><img src="micIcon.png">
    <canvas class="visualTrack1" width="640" height="100" style="border:1px solid #d3d3d3;"> </canvas>
    Volume <input type="range" name="volumeControl" id="volumeControl" min="0" max="1" step="0.05" class="slider" oninput="t1ChangeVolume(this.value);"> <span id="vc1Value">0.5</span> <br />
    Low <input type="range" name="lowControl" min="0" max="200" value = "0" class="slider" step="1" oninput="t1ChangeLow(this.value);"> <span id="bc1Value">0</span> <br />  
    </p>
    <div class="w3-center" id="t1DropArea">Drop a song here!</div>
    <hr class="w3-border-grey" style="margin:auto;width:40%">
    <p class="w3-center slidecontainer"><img src="guitarIcon.png">
    <canvas class="visualTrack2" width="640" height="100" style="border:1px solid #d3d3d3;"></canvas>
    Volume <input type="range" name="volumeControl2" min="0" max="1" step="0.05" class="slider" oninput="t2ChangeVolume(this.value);"> <span id="vc2Value">0.5</span> <br />
    Low <input type="range" name="biquadControl2" min="0" max="200" value = "0" step="1" class="slider" oninput="t2ChangeLow(this.value);"> <span id="bc2Value">0</span> <br />
    </p>
    <div class="w3-center" id="t2DropArea">Drop a song here!</div>
    <hr class="w3-border-grey" style="margin:auto;width:40%">
    <button id="songControl" onclick="songControls()"> Pause </button>
      </div>
  </div>
    <div>Icons made by <a href="http://www.freepik.com" title="Freepik">Freepik</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a> is licensed by <a href="http://creativecommons.org/licenses/by/3.0/" title="Creative Commons BY 3.0" target="_blank">CC 3.0 BY</a></div>
</div>
    
    <script>
                  
        var ctx = new (window.AudioContext || window.webkitAudioContext)();
        var voiceSelect = document.getElementById("voice");
        var source;
        var stream;     
      
      //Setting up nodes for track 1----------------------------
        var t1GainNode = ctx.createGain();
        t1GainNode.gain.value = 0.5;
        
        var t1Analyser = ctx.createAnalyser();
        t1Analyser.minDecibels = -90;
        t1Analyser.maxDecibels = -10;
        t1Analyser.smoothingTimeConstant = 0.85;
        
        var t1Distortion = ctx.createWaveShaper();
        
        var t1LowshelfFilter = ctx.createBiquadFilter();
        t1LowshelfFilter.type = "lowshelf";
        t1LowshelfFilter.frequency.value = 0;
        t1LowshelfFilter.gain.value = 25;
        //Finish setting up nodes for track 1------------------

        //Connecting nodes together for track 1
        t1GainNode.connect(t1LowshelfFilter);
        t1LowshelfFilter.connect(t1Analyser);
        t1Analyser.connect(ctx.destination);
        //Finish connecting nodes together for track 1
        
        //Setting up nodes for track 2-----------------------
        var t2GainNode = ctx.createGain();
        t2GainNode.gain.value = 0.5;
        
        var t2Analyser = ctx.createAnalyser();
        t2Analyser.minDecibels = -90;
        t2Analyser.maxDecibels = -10;
        t2Analyser.smoothingTimeConstant = 0.85;
        
        var t2Distortion = ctx.createWaveShaper();
        
        var t2LowshelfFilter = ctx.createBiquadFilter();
        t2LowshelfFilter.type = "lowshelf";
        t2LowshelfFilter.frequency.value = 0;
        t2LowshelfFilter.gain.value = 25;
        //Finish setting up nodes for track 2--------------

        //Connecting nodes together for track 2
        t2GainNode.connect(t2LowshelfFilter);
        t2LowshelfFilter.connect(t2Analyser);
        t2Analyser.connect(ctx.destination);
        //Finish connecting nodes together for track 2
        
        var intendedWidth = document.querySelector('.wrapper').clientWidth;
        
        var t1Canvas = document.querySelector('.visualTrack1');
        var t1CanvasCtx = t1Canvas.getContext("2d");
        t1Canvas.setAttribute('width',intendedWidth);
        var t1DrawVisual;
        
        var t2Canvas = document.querySelector('.visualTrack2');
        var t2CanvasCtx = t2Canvas.getContext("2d");
        t2Canvas.setAttribute('width',intendedWidth);
        var t2DrawVisual;

        var t1DropArea = document.getElementById('t1DropArea');
        t1DropArea.addEventListener('drop', t1Drop, false);
        t1DropArea.addEventListener('dragover', dragOver, false);
        
        var t2DropArea = document.getElementById('t2DropArea');
        t2DropArea.addEventListener('drop', t2Drop, false);
        t2DropArea.addEventListener('dragover', dragOver, false);
        
        

        function t1InitAudio(data) {
        source = ctx.createBufferSource();

        if(ctx.decodeAudioData) {
            ctx.decodeAudioData(data, function(buffer) {
              t1Buffer = buffer;
              t1Source = ctx.createBufferSource();
              t1Source.buffer = t1Buffer;
              t1Source.connect(t1GainNode);
              t1Source.loop = true;
              t1Source.start();             
              visualize(t1Canvas, t1CanvasCtx, t1Analyser, t1DrawVisual);            
            }, function(e){ console.log("Error with decoding audio data" + e.err);});
        };
        }
        
        function t2InitAudio(data) {
        source = ctx.createBufferSource();

        if(ctx.decodeAudioData) {
            ctx.decodeAudioData(data, function(buffer) {
              t2Buffer = buffer;
              t2Source = ctx.createBufferSource();
              t2Source.buffer = t2Buffer;
              t2Source.connect(t2GainNode);
              t2Source.loop = true;
              t2Source.start();
              visualize(t2Canvas, t2CanvasCtx, t2Analyser, t2DrawVisual);
            }, function(e){ console.log("Error with decoding audio data" + e.err);});
        };
        }
        
        function t1Drop(evt) {
        evt.stopPropagation();
        evt.preventDefault();

        var droppedFiles = evt.dataTransfer.files;

        var reader = new FileReader();


        reader.onload = function(fileEvent) {
            var data = fileEvent.target.result;
            t1InitAudio(data);
        }
        reader.readAsArrayBuffer(droppedFiles[0]);
        }
        
        function t2Drop(evt) {
        evt.stopPropagation();
        evt.preventDefault();

        var droppedFiles = evt.dataTransfer.files;

        var reader = new FileReader();

        reader.onload = function(fileEvent) {
            var data = fileEvent.target.result;
            t2InitAudio(data);
        }
        reader.readAsArrayBuffer(droppedFiles[0]);
        }
    
        function dragOver(evt) {
        evt.stopPropagation();
        evt.preventDefault();
        return false;
    }
    
    
        
        function visualize(canvas, canvasCtx, analyser, drawVisual) {
        WIDTH = canvas.width;
        HEIGHT = canvas.height;
      

        analyser.fftSize = 256;
        var bufferLength = analyser.frequencyBinCount;
        console.log(bufferLength);
        console.log("visualize");
        var dataArray = new Uint8Array(bufferLength);

        canvasCtx.clearRect(0, 0, WIDTH, HEIGHT);

        var draw = function() {
            console.log("draw call");

          drawVisual = requestAnimationFrame(draw);

          analyser.getByteFrequencyData(dataArray);

          canvasCtx.fillStyle = 'rgb(0, 0, 0)';
          canvasCtx.fillRect(0, 0, WIDTH, HEIGHT);

          var barWidth = (WIDTH / bufferLength) * 2.5;
          var barHeight;
          var x = 0;
          
          for(var i = 0; i < bufferLength; i++) {
            barHeight = dataArray[i]/2;

            canvasCtx.fillStyle = 'rgb(' + (barHeight+100) + ',50,50)';
            canvasCtx.fillRect(x,HEIGHT-barHeight/2,barWidth,barHeight);

            x += barWidth + 1;
          }
        };
        draw();
    }

        //Function to pause and resume current song onclick of button        
        function songControls() {
            if(ctx.state === 'running') {
                ctx.suspend().then(function() {
                    document.getElementById("songControl").textContent = "Resume";
                });
            } else if(ctx.state === 'suspended') {
                ctx.resume().then(function() {
                    document.getElementById("songControl").textContent = "Pause";
                });
            }
        }
        //Pause and resume function end
              
        //functions to update values of volume/effects based on change in slider
        function t1ChangeVolume(val) {           
            t1GainNode.gain.value = val;
            document.getElementById('vc1Value').innerHTML = val;
        }
        
        function t1ChangeLow(val) {
            t1LowshelfFilter.frequency.value = val;
            document.getElementById('bc1Value').innerHTML = (val / 2);
        }
        
        function t2ChangeVolume(val) {           
            t2GainNode.gain.value = val;
            document.getElementById('vc2Value').innerHTML = val;
        }
        
        function t2ChangeLow(val) {
            t2LowshelfFilter.frequency.value = val;
            document.getElementById('bc2Value').innerHTML = (val / 2);
        }
    </script>
</body>
</html>
